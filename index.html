<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>人件費見える化ツール</title>

<link rel="icon" href="favicon192192.png" sizes="192x192" />
<link rel="shortcut icon" href="favicon192192.png" />
<link rel="apple-touch-icon" href="favicon192192.png" />

<style>
:root{
  --bg:#f5f8fb; --card:#fff; --ink:#1f2937; --muted:#6b7280;
  --accent:#3aa2c8; --accent-strong:#2384a8; --line:#e7eef3;
  --overlay:rgba(15,23,42,.28); --focus:rgba(58,162,200,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",Arial,sans-serif;color:var(--ink);background:var(--bg);}
.container{max-width:1100px;margin:10px auto;padding:0 10px}

/* header */
header{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.logo{height:48px;width:auto;object-fit:contain;border-radius:4px}
.logo-link{display:inline-block;line-height:0}
h1{font-weight:700;letter-spacing:.3px;line-height:1.05;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;margin:0;font-size:20px}
@media (orientation:portrait){ h1{font-size:clamp(18px,5.6vw,22px);} }
.header-actions{display:flex;gap:6px;align-items:center}
.help-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 9px;border-radius:9px;border:1px solid var(--line);background:#f3f7fb;color:#0f172a;cursor:pointer;font-weight:700;font-size:13.5px}
.help-btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px;box-shadow:0 0 0 6px rgba(58,162,200,.18)}

/* layout */
.grid{display:grid;grid-template-columns:1fr;gap:10px}
@media (min-width:900px){.grid{grid-template-columns:1.1fr 0.9fr}}
@media (max-width:899px) and (orientation:landscape){.grid{grid-template-columns:1fr 1fr}}

.card{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.section{padding:10px 10px 4px 10px;border-bottom:1px solid var(--line)}
.section:last-child{border-bottom:none;padding-bottom:10px}
.section h2{margin:0 0 4px 0;font-size:14px}

.help{font-size:11px;color:var(--muted)}
.row{display:grid;grid-template-columns:130px 1fr;gap:8px;align-items:center;padding:4px 0}
.row + .row{border-top:1px dashed var(--line)}
.label{color:var(--muted);font-size:13.5px;font-weight:600}

/* inputs */
input[type="text"],input[type="number"],select{
  width:100%;padding:7px 9px;font-size:13.5px;border-radius:9px;border:1px solid var(--line);
  background:#f9fbfd;outline:none;transition:border .15s,box-shadow .15s,background .15s;
}
input[type="text"]:focus-visible,input[type="number"]:focus-visible,select:focus-visible{
  border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,162,200,.18);background:#fff;
  outline:3px solid var(--focus);outline-offset:2px;
}

/* slider */
.slider-row{display:grid;grid-template-columns:1fr;gap:3px}
input[type="range"]{width:100%;height:26px;-webkit-appearance:none;appearance:none;background:transparent}
input[type="range"]::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-strong) 100%);border-radius:999px;opacity:.35}
input[type="range"]::-moz-range-track{height:6px;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-strong) 100%);border-radius:999px;opacity:.35}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--accent-strong);margin-top:-6px;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:box-shadow .15s,transform .15s,border-color .15s}
input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--accent-strong);box-shadow:0 2px 6px rgba(0,0,0,.15);transition:box-shadow .15s,transform .15s,border-color .15s}
input[type="range"]:focus-visible{outline:3px solid var(--focus);outline-offset:3px}
input[type="range"]:focus-visible::-webkit-slider-thumb{box-shadow:0 0 0 6px rgba(58,162,200,.25),0 2px 8px rgba(0,0,0,.3);transform:scale(1.05);border-color:#30a0c3}
input[type="range"]:focus-visible::-moz-range-thumb{box-shadow:0 0 0 6px rgba(58,162,200,.25),0 2px 8px rgba(0,0,0,.3);transform:scale(1.05);border-color:#30a0c3}

/* segment */
.seg{display:flex;gap:6px}
.seg button{flex:1;border:1px solid var(--line);background:#f3f7fb;color:#111;padding:6px 8px;border-radius:9px;cursor:pointer;font-weight:700;font-size:13.5px}
.seg button.active{background:linear-gradient(180deg,var(--accent),var(--accent-strong));color:#fff;border-color:transparent}
.seg button:focus-visible{outline:3px solid var(--focus);outline-offset:2px}

/* result */
.result{display:grid;grid-template-columns:1fr;gap:8px;padding:10px}
.tile{border:1px solid var(--line);border-radius:9px;padding:8px;background:linear-gradient(180deg,#fff 0%,#f7fbfe 100%)}
.tile h3{margin:0 0 3px 0;font-size:12.5px;color:var(--muted)}
.main-figure{font-size:24px;font-weight:600;letter-spacing:.2px;color:var(--accent-strong);border-radius:8px;padding:2px 4px}
.main-figure:focus-visible,.permin b:focus-visible,.accent-chip:focus-visible{outline:3px solid var(--focus);outline-offset:3px;box-shadow:0 0 0 6px rgba(58,162,200,.2);background:linear-gradient(180deg,#fff 0%,#eef8fc 100%)}
.figure-row{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
.accent-chip{font-size:13px;font-weight:700;color:var(--accent-strong);background:rgba(58,162,200,.12);border:1px solid rgba(35,132,168,.36);padding:3px 8px;border-radius:999px;white-space:nowrap}

/* 1分あたり強調 */
.permin{margin-top:2px;font-weight:700;color:var(--accent-strong);display:inline-flex;align-items:baseline;gap:6px}
.permin b{font-size:22px;font-weight:700;border-radius:6px;padding:1px 4px}

/* buttons */
.btn{display:inline-flex;gap:6px;align-items:center;padding:7px 10px;background:linear-gradient(180deg,var(--accent),var(--accent-strong));border:none;color:#fff;border-radius:9px;cursor:pointer;font-weight:700}
.btn.secondary{background:#eef5f9;color:#2384a8;border:1px solid var(--line)}
.btn.outline{background:#fff;color:#2384a8;border:1px solid var(--accent-strong)}
.btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
.btns{display:flex;gap:6px;justify-content:flex-end}

.footer{font-size:11px;color:#6b7280;padding:6px 10px 10px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.hr{height:1px;background:var(--line);margin:6px 0}

/* mini footer (CC) */
.mk-mini{ text-align:center;font-size:12px;color:#7b8794;padding:10px 10px 14px;border-top:1px solid var(--line);margin-top:8px;white-space:nowrap;overflow-x:auto }
.mk-mini a{color:inherit;text-decoration:underline}
.mk-mini::-webkit-scrollbar{height:8px}
.mk-mini::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}

.switch{display:flex;align-items:center;gap:8px}
.err{color:#b91c1c;font-size:11.5px;display:none}
.toast{position:fixed;left:8px;right:8px;bottom:8px;background:#111;color:#fff;padding:8px 10px;border-radius:8px;opacity:.95;font-size:12px;z-index:9999;text-align:center}

/* print */
@media print{
  body{background:#fff}
  .card{box-shadow:none}
  .btns{display:none}
  .mk-mini{border-top:none}
  #tourBanner,.tour-overlay,.tour-tip{display:none!important}
}

/* Tutorial */
#tourBanner{display:none;margin:6px 0 10px 0;padding:8px 10px;border:1px solid var(--line);background:#f0f7fb;border-radius:10px;font-size:13px;color:#0f172a;align-items:center;justify-content:space-between;gap:8px}
#tourBanner .actions{display:flex;gap:8px}
#tourBanner button{padding:6px 9px;border-radius:8px;border:1px solid var(--accent-strong);background:#fff;color:#2384a8;font-weight:700;cursor:pointer}
#tourBanner .skip{border-color:var(--line);color:#334155}

.tour-overlay{position:fixed;inset:0;background:var(--overlay);z-index:9998;pointer-events:none}
.tour-tip{position:fixed;max-width:420px;background:#fff;color:#0f172a;border-radius:12px;border:1px solid #e2e8f0;box-shadow:0 10px 30px rgba(0,0,0,.18);z-index:10020;padding:12px 12px 10px 12px}
.tour-tip h4{margin:0 0 6px 0;font-size:15px}
.tour-tip p{margin:0 0 10px 0;font-size:13px;color:#334155;line-height:1.5}
.tour-ctrl{display:flex;justify-content:space-between;align-items:center;gap:8px}
.tour-ctrl .left{display:flex;gap:6px}
.tour-ctrl .right{display:flex;gap:6px}
.tour-btn{padding:6px 10px;border-radius:9px;border:1px solid var(--line);background:#f8fafc;color:#0f172a;font-weight:700;cursor:pointer;font-size:13px}
.tour-btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-strong));color:#fff;border-color:transparent}
.tour-btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}

/* Docked tip for small screens */
.tour-tip.docked{left:8px!important;right:8px!important;bottom:8px!important;top:auto!important;max-width:none}

/* Highlight */
.tour-target{position:relative;z-index:10010!important;border-radius:12px;background:#fff!important;box-shadow:0 0 0 6px rgba(58,162,200,.38),0 12px 42px rgba(0,0,0,.35)!important}
</style>
</head>
<body>
<div class="container">
  <header>
    <a class="logo-link" href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener" aria-label="税理士法人松本会計事務所 公式サイト">
      <img src="ロゴ.jpg" alt="松本会計ロゴ" class="logo"/>
    </a>
    <h1>人件費見える化ツール</h1>
    <div class="header-actions">
      <button id="helpBtn" class="help-btn" aria-haspopup="dialog" aria-controls="tour">チュートリアル</button>
    </div>
  </header>

  <!-- Onboarding banner -->
  <div id="tourBanner" role="region" aria-label="初回ガイド">
    <div>はじめての方へ：このツールの使い方を <b>2分</b> でご案内します。</div>
    <div class="actions">
      <button id="startTourBtn">チュートリアルを開始</button>
      <button id="skipTourBtn" class="skip">今回はスキップ</button>
    </div>
  </div>

  <div class="grid">
    <!-- left -->
    <div class="card">
      <div class="section">
        <h2>1) 入力</h2>

        <div class="row">
          <div class="label">給与の単位</div>
          <div class="seg" role="tablist" aria-label="給与の単位">
            <button id="btnHourly" aria-selected="false">時給</button>
            <button id="btnMonthly" aria-selected="false">月給</button>
            <button id="btnYearly" class="active" aria-selected="true">年収</button>
          </div>
        </div>

        <div class="row">
          <div class="label"><span id="salaryLabel">年収（税引前）</span></div>
          <div class="slider-row">
            <input id="salary" type="text" inputmode="numeric" placeholder="例：4,780,000" value="4,780,000"/>
            <input id="salaryRange" type="range" min="1000000" max="30000000" step="10000"/>
          </div>
        </div>

        <div class="row">
          <div class="label">社保上乗せ</div>
          <div class="switch">
            <input id="overheadSoc" type="checkbox"/>
            <label for="overheadSoc" class="help">社会保険の<b>事業主負担</b>を上乗せ（標準率を適用）</label>
          </div>
        </div>
      </div>

      <div class="section" id="monthlyBlock" style="display:none">
        <h2>2) 稼働時間（<span style="color:var(--accent-strong)">月給ベース</span>）</h2>
        <div class="row"><div class="label">月の稼働日数</div><input id="mDays" type="number" inputmode="numeric" min="1" max="31" step="1" value="20"/></div>
        <div class="help err" id="err_mDays"></div>
        <div class="row"><div class="label">1日の労働時間</div><input id="mHoursPerDay" type="text" inputmode="decimal" placeholder="例：7.5" value="8"/></div>
        <div class="help err" id="err_mHoursPerDay"></div>
        <div class="row"><div class="label">月の稼働時間</div><input id="mHours" type="number" min="1" step="1" value="160"/></div>
        <div class="help">※ 上の2項目を変更すると自動で再計算（手入力も可）。</div>
      </div>

      <div class="section" id="yearlyBlock">
        <h2>2) 稼働時間（<span style="color:var(--accent-strong)">年収ベース</span>）</h2>
        <div class="row"><div class="label">年間の稼働日数</div><input id="yDays" type="number" inputmode="numeric" min="1" max="366" step="1" value="240"/></div>
        <div class="help err" id="err_yDays"></div>
        <div class="row"><div class="label">1日の労働時間</div><input id="yHoursPerDay" type="text" inputmode="decimal" placeholder="例：7.5" value="8"/></div>
        <div class="help err" id="err_yHoursPerDay"></div>
        <div class="row"><div class="label">年間の稼働時間</div><input id="yHours" type="number" min="1" step="1" value="1920"/></div>
        <div class="help">※ 上の2項目を変更すると自動で再計算（手入力も可）。</div>
      </div>

      <div class="section">
        <h2>3) 所要時間</h2>
        <div class="row">
          <div class="label">所要時間（h）</div>
          <div class="slider-row">
            <input id="useHours" type="number" inputmode="decimal" min="0" step="0.25" value="1.0"/>
            <input id="useHoursRange" type="range" min="0" max="12" step="0.25"/>
          </div>
        </div>
      </div>
    </div>

    <!-- right -->
    <div class="card">
      <div class="section">
        <h2>結果</h2>
        <div class="result">
          <div class="tile" id="tileHourly">
            <h3>時間単価（税込/ベース×上乗せ率）</h3>
            <div class="main-figure" id="hourly" tabindex="0" aria-label="時間単価">–</div>
            <div class="permin">1分あたり：<b id="perMin" tabindex="0" aria-label="1分あたり単価">–</b></div>
            <div class="help">社保上乗せ率（標準）：<b id="socRateLabel">–</b></div>
          </div>

          <div class="tile" id="tileCost">
            <h3>所要時間のコスト</h3>
            <div class="figure-row">
              <div class="main-figure" id="cost" tabindex="0" aria-label="所要時間のコスト">–</div>
              <div class="accent-chip" id="costTimes12" tabindex="0" aria-label="12倍の目安">（×12＝—）</div>
            </div>
            <div class="help">15分：<b id="c15">–</b> ／ 30分：<b id="c30">–</b> ／ 1時間：<b id="c60">–</b></div>
          </div>

          <div class="tile">
            <h3>前提（現在の設定）</h3>
            <div class="grid-2">
              <div><div class="help">給与ベース</div><div id="baseKind" style="font-weight:700">年収</div></div>
              <div><div class="help">社保上乗せ</div><div id="vhOverheadSoc" style="font-weight:700">なし</div></div>
            </div>
            <div class="hr"></div>
            <div class="grid-2">
              <div><div class="help">対象給与</div><div id="vhSalary" style="font-weight:700">–</div></div>
              <div><div class="help">稼働時間（基準）</div><div id="vhWorkH" style="font-weight:700">–</div></div>
            </div>
          </div>

          <div class="btns">
            <button id="copyBtn" class="btn">コピー</button>
            <button id="resetBtn" class="btn secondary">リセット</button>
            <button id="printBtn" class="btn outline">印刷</button>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="note">※ このツールは、単純な換算法（時間単価＝給与÷稼働時間）に基づきます。労基法上の一般的な所定労働時間（1日8時間・週40時間）に合わせ、初期値を 8h×20日/月・8h×240日/年としてあります。また、社保上乗せは標準率を使用しており、実際の料率は保険者・業種・地域・年度等により異なります。</div>
      </div>
    </div>
  </div>

  <footer class="mk-mini">
    © <span id="cpy-year">2025</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
    <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
    <span id="build-rev">r36</span>（<span id="last-updated-date"></span>）
  </footer>
</div>

<script>
(function(){
  'use strict';
  var VERSION='r36';
  var SOC_RATE=16.0;
  var TUTORIAL_SEEN_KEY='rate_tool_tutorial_seen_v1';
  var KEY='rate_tool_r36';
  var initialized=false;

  function el(id){return document.getElementById(id)}
  function on(id,ev,fn){var e=el(id);if(e){e.addEventListener?e.addEventListener(ev,fn,false):e.attachEvent('on'+ev,fn)}}
  function fmtJPY(n){try{return new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(n)}catch(_){try{return '¥'+(Math.round(n)).toLocaleString('ja-JP')}catch(__){return '¥'+String(Math.round(n))}}}
  function clamp(v,min,max){v=Number(v);if(!isFinite(v))return v;if(v<min)return min;if(v>max)return max;return v}

  var state={mode:'yearly',salary:4780000,overheadSoc:false,mDays:20,mHoursPerDay:8,mHours:160,yDays:240,yHoursPerDay:8,yHours:1920,useHours:1};

  function monthlyHours(){return Number(state.mHours)||0}
  function yearlyHours(){return Number(state.yHours)||0}
  function baseSalary(){return Number(state.salary)||0}
  function loadedSalary(){return baseSalary()*(1+(state.overheadSoc?SOC_RATE/100:0))}
  function hourlyRate(){var d=state.mode==='monthly'?monthlyHours():state.mode==='yearly'?yearlyHours():1;var r=d>0?loadedSalary()/d:0;return Math.round(r)}
  function costFor(h){return Math.round(hourlyRate()*(Number(h)||0))}

  function setSegment(){
    ['btnHourly','btnMonthly','btnYearly'].forEach(function(id){var b=el(id);if(b)b.classList.remove('active')});
    if(state.mode==='hourly')el('btnHourly').classList.add('active');
    if(state.mode==='monthly')el('btnMonthly').classList.add('active');
    if(state.mode==='yearly')el('btnYearly').classList.add('active');
    el('salaryLabel').textContent=state.mode==='monthly'?'月給（税引前）':state.mode==='yearly'?'年収（税引前）':'時給（税引前）';
  }
  function syncSalaryRange(){
    var r=el('salaryRange');if(!r)return;
    if(state.mode==='monthly'){r.min=100000;r.max=2000000;r.step=1000}
    else if(state.mode==='yearly'){r.min=1000000;r.max=30000000;r.step=10000}
    else{r.min=800;r.max=10000;r.step=10}
    r.value=String(baseSalary());
  }
  function syncUseHoursRange(){var r=el('useHoursRange');if(r){r.min=0;r.max=12;r.step=0.25;r.value=String(state.useHours||0)}}
  function updateVisibility(){
    var mb=el('monthlyBlock'),yb=el('yearlyBlock');
    if(state.mode==='monthly'){mb.style.display='';yb.style.display='none'}
    else if(state.mode==='yearly'){mb.style.display='none';yb.style.display=''}
    else{mb.style.display='none';yb.style.display='none'}
  }
  function updateView(){
    setSegment();syncSalaryRange();syncUseHoursRange();updateVisibility();
    el('vhSalary').textContent=fmtJPY(baseSalary());
    el('vhOverheadSoc').textContent=state.overheadSoc?('あり（'+SOC_RATE+'%）'):'なし';
    el('socRateLabel').textContent=SOC_RATE+'%';
    var w=state.mode==='monthly'?monthlyHours():state.mode==='yearly'?yearlyHours():null;
    el('vhWorkH').textContent=(w==null)?'—':(w.toLocaleString('ja-JP')+' 時間/'+(state.mode==='monthly'?'月':'年'));

    var h=hourlyRate();
    el('hourly').textContent=fmtJPY(h)+' / 時間';
    el('perMin').textContent=fmtJPY(Math.round(h/60));

    var useH=Number(state.useHours)||0;
    var cVal=costFor(useH);
    el('cost').textContent=fmtJPY(cVal);
    el('costTimes12').textContent='（×12＝'+fmtJPY(cVal*12)+'）';
    el('c15').textContent=fmtJPY(costFor(0.25));
    el('c30').textContent=fmtJPY(costFor(0.5));
    el('c60').textContent=fmtJPY(costFor(1));

    el('baseKind').textContent=state.mode==='monthly'?'月給':state.mode==='yearly'?'年収':'時給';
  }

  /* money input with commas */
  function liveFormatSalary(){
    var input=el('salary');var raw=input.value;var cleaned=raw.replace(/[^\d]/g,'');
    if(cleaned===''){state.salary=0;input.value='';el('salaryRange').value='0';updateView();save();return}
    var n=Number(cleaned);state.salary=n;input.value=n.toLocaleString('ja-JP');
    try{input.setSelectionRange(input.value.length,input.value.length)}catch(_){}
    el('salaryRange').value=String(n);updateView();save();
  }

  function recalcMonthly(soft){if(soft===undefined)soft=true;var d=Number(state.mDays);var hpd=parseFloat(state.mHoursPerDay);if(!isFinite(d)||isNaN(hpd))return;
    if(!soft){d=clamp(d,1,31);hpd=clamp(hpd,0.1,24);state.mDays=d;state.mHoursPerDay=hpd;el('mDays').value=String(d);el('mHoursPerDay').value=String(hpd)}
    state.mHours=d*hpd;el('mHours').value=String(state.mHours)}
  function recalcYearly(soft){if(soft===undefined)soft=true;var d=Number(state.yDays);var hpd=parseFloat(state.yHoursPerDay);if(!isFinite(d)||isNaN(hpd))return;
    if(!soft){d=clamp(d,1,366);hpd=clamp(hpd,0.1,24);state.yDays=d;state.yHoursPerDay=hpd;el('yDays').value=String(d);el('yHoursPerDay').value=String(hpd)}
    state.yHours=d*hpd;el('yHours').value=String(state.yHours)}

  function showToast(msg){var t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(function(){t.remove()},1500)}
  function copySummary(){
    var base=state.mode==='monthly'?'月給':state.mode==='yearly'?'年収':'時給';
    var work=state.mode==='monthly'?('稼働時間：'+state.mHours.toLocaleString('ja-JP')+' 時間/月'):
             state.mode==='yearly'?('稼働時間：'+state.yHours.toLocaleString('ja-JP')+' 時間/年'):'稼働時間：—（時給ベース）';
    var txt=['【時間単価・コスト可視化】','給与ベース：'+base,'対象給与：'+fmtJPY(baseSalary()),'社保上乗せ：'+(state.overheadSoc?('あり（'+SOC_RATE+'%）'):'なし'),work,'時間単価：'+fmtJPY(hourlyRate())+' /h','1分あたり：'+fmtJPY(Math.round(hourlyRate()/60)),'15分：'+fmtJPY(costFor(0.25))+' ／ 30分：'+fmtJPY(costFor(0.5))+' ／ 1時間：'+fmtJPY(costFor(1)),'(ver '+VERSION+')'].join('\n');
    if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(txt).then(function(){showToast('コピーしました')}).catch(function(){fallbackCopy(txt)})}else{fallbackCopy(txt)}
  }
  function fallbackCopy(txt){var ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();try{document.execCommand('copy')}catch(e){}ta.remove();showToast('コピーしました')}
  function resetAll(){state={mode:'yearly',salary:4780000,overheadSoc:false,mDays:20,mHoursPerDay:8,mHours:160,yDays:240,yHoursPerDay:8,yHours:1920,useHours:1};
    el('salary').value='4,780,000';el('overheadSoc').checked=false;el('mDays').value='20';el('mHoursPerDay').value='8';el('mHours').value='160';
    el('yDays').value='240';el('yHoursPerDay').value='8';el('yHours').value='1920';el('useHours').value='1.0';
    syncUseHoursRange();syncSalaryRange();updateView();save();showToast('リセットしました');
    ['err_mDays','err_mHoursPerDay','err_yDays','err_yHoursPerDay'].forEach(function(id){var e=el(id);if(e)e.style.display='none'})}
  function defaultSalaryFor(m){return m==='hourly'?2000:m==='yearly'?4780000:300000}
  function resetSalaryForMode(){state.salary=defaultSalaryFor(state.mode);el('salary').value=state.salary.toLocaleString('ja-JP');syncSalaryRange();el('salaryRange').value=String(state.salary)}

  /* events */
  on('btnMonthly','click',function(){state.mode='monthly';resetSalaryForMode();updateView();save()})
  on('btnYearly','click',function(){state.mode='yearly';resetSalaryForMode();updateView();save()})
  on('btnHourly','click',function(){state.mode='hourly';resetSalaryForMode();updateView();save()})

  on('salary','input',liveFormatSalary); on('salary','blur',liveFormatSalary);
  on('salaryRange','input',function(e){state.salary=Number(e.target.value)||0;el('salary').value=state.salary.toLocaleString('ja-JP');updateView();save()})
  on('salaryRange','change',function(e){state.salary=Number(e.target.value)||0;el('salary').value=state.salary.toLocaleString('ja-JP');updateView();save()})
  on('overheadSoc','change',function(e){state.overheadSoc=!!e.target.checked;updateView();save()})

  on('mDays','input',function(e){var n=Number(e.target.value);if(isFinite(n)){state.mDays=n;recalcMonthly(true);updateView();save()}})
  on('mDays','blur',function(e){var n=Number(e.target.value);if(!isFinite(n))n=20;var raw=n;n=clamp(n,1,31);if(raw>31)showErr('err_mDays','月の稼働日数の上限は31日です（入力値を補正しました）');state.mDays=n;e.target.value=String(n);recalcMonthly(false);updateView();save()})
  on('mHoursPerDay','input',function(e){var v=e.target.value;if(v==='')return;var n=parseFloat(v);if(!isNaN(n)){state.mHoursPerDay=n;recalcMonthly(true);updateView();save()}})
  on('mHoursPerDay','blur',function(e){var v=e.target.value.trim();var n=parseFloat(v);if(isNaN(n))n=8;var raw=n;n=clamp(n,0.1,24);if(raw>24)showErr('err_mHoursPerDay','1日の労働時間の上限は24時間です（入力値を補正しました）');state.mHoursPerDay=n;e.target.value=String(n);recalcMonthly(false);updateView();save()})
  on('mHours','input',function(e){var n=Number(e.target.value);if(isFinite(n)){state.mHours=n;updateView();save()}})

  on('yDays','input',function(e){var n=Number(e.target.value);if(isFinite(n)){state.yDays=n;recalcYearly(true);updateView();save()}})
  on('yDays','blur',function(e){var n=Number(e.target.value);if(!isFinite(n))n=240;var raw=n;n=clamp(n,1,366);if(raw>366)showErr('err_yDays','年間の稼働日数の上限は366日です（入力値を補正しました）');state.yDays=n;e.target.value=String(n);recalcYearly(false);updateView();save()})
  on('yHoursPerDay','input',function(e){var v=e.target.value;if(v==='')return;var n=parseFloat(v);if(!isNaN(n)){state.yHoursPerDay=n;recalcYearly(true);updateView();save()}})
  on('yHoursPerDay','blur',function(e){var v=e.target.value.trim();var n=parseFloat(v);if(isNaN(n))n=8;var raw=n;n=clamp(n,0.1,24);if(raw>24)showErr('err_yHoursPerDay','1日の労働時間の上限は24時間です（入力値を補正しました）');state.yHoursPerDay=n;e.target.value=String(n);recalcYearly(false);updateView();save()})
  on('yHours','input',function(e){var n=Number(e.target.value);if(isFinite(n)){state.yHours=n;updateView();save()}})

  on('useHours','input',function(e){var n=parseFloat(e.target.value);if(!isNaN(n)){state.useHours=n;el('useHoursRange').value=String(state.useHours);updateView();save()}})
  on('useHoursRange','input',function(e){state.useHours=Number(e.target.value)||0;el('useHours').value=String(state.useHours);updateView();save()})

  on('copyBtn','click',copySummary);
  on('resetBtn','click',resetAll);
  on('printBtn','click',function(){window.print()});

  var errTimers={}; function showErr(id,msg){var e=el(id);if(!e)return;e.textContent=msg;e.style.display='block';clearTimeout(errTimers[id]);errTimers[id]=setTimeout(function(){e.style.display='none'},2600)}

  function save(){try{localStorage.setItem(KEY,JSON.stringify(state))}catch(e){}}
  function load(){try{var s=JSON.parse(localStorage.getItem(KEY)||localStorage.getItem('rate_tool_r35')||'null');if(s)state=s}catch(e){}}

  function initFooter(){
    var y=new Date().getFullYear();var cpy=el('cpy-year');if(cpy)cpy.textContent=String(y);
    var d;try{d=new Date(document.lastModified)}catch(_){d=new Date()}
    if(!(d instanceof Date)||isNaN(d.getTime()))d=new Date();
    var iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    var lu=el('last-updated-date');if(lu)lu.textContent=iso;
    var br=el('build-rev');if(br)br.textContent=VERSION;
  }

  /* ===== Tutorial ===== */
  var tour={running:false,idx:0,overlay:null,tip:null,targetEl:null,snapshot:null,steps:[
    {sel:'.seg',title:'1. 給与の単位を選ぶ',desc:'「時給・月給・年収」から計算の前提を選択します。'},
    {sel:'#salary',title:'2. ベース金額の入力',desc:'金額はカンマ付きで入力できます。下のスライダーでも調整できます。'},
    {sel:'#overheadSoc',title:'3. 社保上乗せ',desc:'事業主負担の社会保険料を上乗せして、人件費の総額視点に切り替えます。'},
    {ensure:function(){if(state.mode!=='yearly'){state.mode='yearly';setSegment();updateVisibility();updateView();}},sel:'#yearlyBlock',title:'4. 稼働時間（年収ベース）',desc:'年間の稼働日数・1日の労働時間から年間稼働時間が自動計算されます。'},
    {ensure:function(){if(state.mode!=='monthly'){state.mode='monthly';setSegment();updateVisibility();updateView();}},sel:'#monthlyBlock',title:'5. 稼働時間（月給ベース）',desc:'月給の場合は月の稼働日数・1日の労働時間から月間稼働時間が算出されます。'},
    {ensure:function(){if(state.mode!=='yearly'){state.mode='yearly';setSegment();updateVisibility();updateView();}},sel:'#useHoursRange',title:'6. 所要時間の入力',desc:'想定する作業時間（h）をスライダーで指定します。（0.25h=15分）'},
    {sel:'#hourly',title:'7. 時間単価の確認',desc:'給与÷稼働時間に社保上乗せを反映した「時間単価」と、1分あたりの単価が表示されます。'},
    {sel:'#cost',title:'8. 所要時間のコスト',desc:'入力した所要時間に応じたコストです。右側の（×12）は12倍の目安です。'},
    {sel:'.btns',title:'9. 共有・印刷・リセット',desc:'「コピー」で結果サマリをテキスト化、「印刷」で画面全体を出力、「リセット」で既定値に戻せます。'},
    {sel:'footer.mk-mini',title:'10. 利用条件とバージョン',desc:'フッターにライセンス（CC BY-NC-SA 4.0）、利用条件、バージョン（r番号）と最終更新日を表示します。'}
  ]};

  function qs(s){return document.querySelector(s)}
  function closestOf(el,sel){if(!el)return null; if(el.closest)return el.closest(sel); var n=el;while(n){if(n.matches&&n.matches(sel))return n;n=n.parentElement}return null}
  function resolveHighlightElement(base){
    var el=base;if(!el)return null;
    if(el.tagName==='INPUT' && el.type==='range'){var w=closestOf(el,'.slider-row');if(w)el=w}
    if(el.id==='hourly'){var t=closestOf(el,'#tileHourly');if(t)el=t}
    if(el.id==='cost'||el.id==='costTimes12'||el.id==='perMin'){var t2=closestOf(el,'#tileCost');if(t2)el=t2}
    return el;
  }

  function createOverlay(){
    var o=document.createElement('div');o.className='tour-overlay';o.setAttribute('aria-hidden','true');
    var t=document.createElement('div');t.className='tour-tip';t.setAttribute('role','dialog');t.setAttribute('aria-live','polite');
    t.innerHTML=['<h4 id="tourTitle"></h4>','<p id="tourDesc"></p>','<div class="tour-ctrl">','<div class="left"><button class="tour-btn" id="tourPrev">前へ</button></div>','<div class="right"><button class="tour-btn" id="tourSkip">スキップ</button><button class="tour-btn primary" id="tourNext">次へ</button><button class="tour-btn" id="tourDone">完了</button></div>','</div>'].join('');
    document.body.appendChild(o);document.body.appendChild(t);
    tour.overlay=o;tour.tip=t;
    t.querySelector('#tourPrev').addEventListener('click',prevStep);
    t.querySelector('#tourNext').addEventListener('click',nextStep);
    t.querySelector('#tourSkip').addEventListener('click',endTour);
    t.querySelector('#tourDone').addEventListener('click',endTour);
    window.addEventListener('resize',positionTip,{passive:true});
    window.addEventListener('scroll',positionTip,{passive:true});
    document.addEventListener('keydown',onTourKeydown);
  }
  function destroyOverlay(){if(tour.tip){tour.tip.remove();tour.tip=null}if(tour.overlay){tour.overlay.remove();tour.overlay=null}window.removeEventListener('resize',positionTip);window.removeEventListener('scroll',positionTip);document.removeEventListener('keydown',onTourKeydown)}
  function onTourKeydown(e){if(!tour.running)return;if(e.key==='ArrowRight')nextStep();else if(e.key==='ArrowLeft')prevStep();else if(e.key==='Escape')endTour()}
  function clearHighlight(){if(tour.targetEl){tour.targetEl.classList.remove('tour-target');tour.targetEl=null}}
  function highlightTarget(sel){
    clearHighlight();var base=qs(sel);var el=resolveHighlightElement(base);if(!el)return null;
    el.classList.add('tour-target');tour.targetEl=el;el.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'});return el;
  }

  function shouldDock(){return (window.innerWidth<640)||(window.innerHeight<640)}
  function positionTip(){
    if(!tour.tip||!tour.targetEl)return;
    var tip=tour.tip; tip.classList.remove('docked');
    if(shouldDock()){ tip.classList.add('docked'); return; }

    var r=tour.targetEl.getBoundingClientRect(); var pad=10;
    var top=r.bottom+pad; var left=Math.max(8,Math.min(window.innerWidth-tip.offsetWidth-8,r.left));
    tip.style.left=left+'px'; tip.style.top=top+'px';
    // overlap / overflow -> try above, then right
    var overflowBottom=top+tip.offsetHeight>window.innerHeight-8;
    var overlap=!(top>r.bottom+pad||(top+tip.offsetHeight)<r.top-pad) && !(left>r.right || (left+tip.offsetWidth)<r.left);
    if(overlap||overflowBottom){
      top=r.top-tip.offsetHeight-pad; tip.style.top=Math.max(8,top)+'px';
      var overlap2=!(top>r.bottom+pad||(top+tip.offsetHeight)<r.top-pad) && !(left>r.right || (left+tip.offsetWidth)<r.left);
      if(overlap2){ top=Math.max(8,r.top); left=Math.min(window.innerWidth-tip.offsetWidth-8,r.right+pad); tip.style.top=top+'px'; tip.style.left=left+'px'; }
    }
  }
  function showStep(i){
    tour.idx=i; var step=tour.steps[i]; if(step.ensure)step.ensure();
    highlightTarget(step.sel);
    tour.tip.querySelector('#tourTitle').textContent=step.title;
    tour.tip.querySelector('#tourDesc').textContent=step.desc;
    var isLast=(i===tour.steps.length-1); tour.tip.querySelector('#tourNext').textContent=isLast?'次へ（終了）':'次へ';
    setTimeout(positionTip,50);
  }
  function nextStep(){ if(tour.idx<tour.steps.length-1){showStep(tour.idx+1)} else {endTour()} }
  function prevStep(){ if(tour.idx>0){showStep(tour.idx-1)} }
  function startTour(){
    if(tour.running)return;
    tour.snapshot=JSON.parse(JSON.stringify(state)); tour.running=true;
    if(!tour.overlay)createOverlay(); tour.overlay.style.display='block'; tour.tip.style.display='block';
    showStep(0);
  }
  function endTour(){
    if(!tour.running)return; tour.running=false;
    if(tour.snapshot){state=tour.snapshot;tour.snapshot=null;updateVisibility();setSegment();syncSalaryRange();syncUseHoursRange();updateView()}
    clearHighlight(); destroyOverlay(); save(); try{localStorage.setItem(TUTORIAL_SEEN_KEY,'1')}catch(e){}
  }

  function load(){try{var s=JSON.parse(localStorage.getItem(KEY)||localStorage.getItem('rate_tool_r35')||'null');if(s)state=s}catch(e){}}
  function init(){
    if(initialized)return; initialized=true;
    load();
    el('salary').value=(state.salary||0).toLocaleString('ja-JP');
    el('overheadSoc').checked=!!state.overheadSoc;
    el('mDays').value=state.mDays; el('mHoursPerDay').value=state.mHoursPerDay; el('mHours').value=state.mHours;
    el('yDays').value=state.yDays; el('yHoursPerDay').value=state.yHoursPerDay; el('yHours').value=state.yHours;
    el('useHours').value=state.useHours;
    syncUseHoursRange(); syncSalaryRange(); updateVisibility(); updateView();
    // footer
    (function initFooter(){
      var y=new Date().getFullYear(); var c=el('cpy-year'); if(c)c.textContent=String(y);
      var d;try{d=new Date(document.lastModified)}catch(_){d=new Date()}
      if(!(d instanceof Date)||isNaN(d.getTime()))d=new Date();
      var iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      var lu=el('last-updated-date'); if(lu) lu.textContent=iso;
      var br=el('build-rev'); if(br) br.textContent=VERSION;
    })();

    on('helpBtn','click',function(){startTour()});
    var banner=el('tourBanner'); var seen=false; try{seen=!!localStorage.getItem(TUTORIAL_SEEN_KEY)}catch(e){}
    if(!seen&&banner){banner.style.display='flex'}
    on('startTourBtn','click',function(){if(banner)banner.style.display='none';startTour()});
    on('skipTourBtn','click',function(){if(banner)banner.style.display='none';try{localStorage.setItem(TUTORIAL_SEEN_KEY,'1')}catch(e){}});
  }

  if(document.readyState==='interactive'||document.readyState==='complete')init();
  window.addEventListener('DOMContentLoaded',init,false);
})();
</script>
</body>
</html>