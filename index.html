<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>時間単価・コスト可視化ツール</title>
  <style>
    :root{ --bg:#f5f8fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --accent:#3aa2c8; --accent-strong:#2384a8; --line:#e7eef3; --good:#10b981; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",Arial,sans-serif; color:var(--ink); background:var(--bg);}   
    .container{max-width:1100px; margin:10px auto; padding:0 10px;} /* 余白圧縮 */
    header{display:flex; gap:6px; align-items:center; margin-bottom:6px;}
    .badge{background:linear-gradient(180deg,var(--accent),var(--accent-strong)); color:#fff; padding:3px 7px; border-radius:999px; font-size:10.5px;}
    h1{font-size:17px; margin:0; font-weight:700; letter-spacing:.3px; line-height:1.05;}
    @media (orientation:portrait){ h1{ font-size:14px; } }

    .grid{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width:900px){ .grid{grid-template-columns: 1.1fr 0.9fr;} }
    @media (max-width:899px) and (orientation: landscape){ .grid{grid-template-columns:1fr 1fr;} }

    .card{background:var(--card); border:1px solid var(--line); border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.04);}    
    .section{padding:10px 10px 4px 10px; border-bottom:1px solid var(--line);}   
    .section:last-child{border-bottom:none; padding-bottom:10px;}
    .section h2{margin:0 0 4px 0; font-size:14px;}

    .help{font-size:11px; color:var(--muted);}    
    .row{display:grid; grid-template-columns:130px 1fr; gap:8px; align-items:center; padding:4px 0;} 
    .row + .row{border-top:1px dashed var(--line);}    
    .label{color:var(--muted); font-size:12px;}

    input[type="text"], input[type="number"], select{ width:100%; padding:7px 9px; font-size:13.5px; border-radius:9px; border:1px solid var(--line); background:#f9fbfd; outline:none; transition:border .15s, box-shadow .15s, background .15s; }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(58,162,200,.18); background:#fff; }

    /* スライダー（給与・所要時間） */
    .slider-row{display:grid; grid-template-columns:1fr; gap:3px;}
    input[type="range"]{ width:100%; height:26px; -webkit-appearance:none; appearance:none; background:transparent; }
    input[type="range"]::-webkit-slider-runnable-track{ height:6px; background:linear-gradient(90deg,var(--accent) 0%, var(--accent-strong) 100%); border-radius:999px; opacity:.35; }
    input[type="range"]::-moz-range-track{ height:6px; background:linear-gradient(90deg,var(--accent) 0%, var(--accent-strong) 100%); border-radius:999px; opacity:.35; }
    input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent-strong); margin-top:-5px; box-shadow:0 2px 6px rgba(0,0,0,.15); }
    input[type="range"]::-moz-range-thumb{ width:16px; height:16px; border-radius:50%; background:var(--accent-strong); box-shadow:0 2px 6px rgba(0,0,0,.15); border:none; }

    .seg{display:flex; gap:6px;}
    .seg button{flex:1; border:1px solid var(--line); background:#f3f7fb; color:#111; padding:6px 8px; border-radius:9px; cursor:pointer; font-weight:600; font-size:13.5px;}
    .seg button.active{background:linear-gradient(180deg,var(--accent),var(--accent-strong)); color:#fff; border-color:transparent;}

    .result{ display:grid; grid-template-columns:1fr; gap:8px; padding:10px; }
    .tile{border:1px solid var(--line); border-radius:9px; padding:8px; background:linear-gradient(180deg,#ffffff 0%, #f7fbfe 100%);}    
    .tile h3{margin:0 0 3px 0; font-size:12.5px; color:var(--muted);}    
    .main-figure{font-size:24px; font-weight:700; letter-spacing:.2px;}
    #hourly{ color:var(--accent-strong); }
    #cost{ color:var(--good); }

    .btn{display:inline-flex; gap:6px; align-items:center; padding:7px 10px; background:linear-gradient(180deg,var(--accent),var(--accent-strong)); border:none; color:#fff; border-radius:9px; cursor:pointer; font-weight:700;}
    .btn.secondary{background:#eef5f9; color:var(--accent-strong); border:1px solid var(--line);} 

    .footer{font-size:11px; color:var(--muted); padding:6px 10px 10px;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:6px;}
    .hr{height:1px; background:var(--line); margin:6px 0;}

    .credit{ text-align:center; font-size:12px; color:#7b8794; padding:10px 0 12px; }
    .switch{ display:flex; align-items:center; gap:8px; }

    /* エラー */
    .err{ color:#b91c1c; font-size:11.5px; display:none; }

    /* トースト */
    .toast{ position:fixed; left:8px; right:8px; bottom:8px; background:#111; color:#fff; padding:8px 10px; border-radius:8px; opacity:0.95; font-size:12px; z-index:9999; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="badge">人件費の見える化</span>
      <h1>時間単価・コスト可視化ツール</h1>
    </header>

    <div class="grid">
      <!-- 左：入力 -->
      <div class="card">
        <div class="section">
          <h2>1) 入力</h2>
          <div class="row">
            <div class="label">給与の単位</div>
            <div class="seg" role="tablist" aria-label="給与の単位">
              <button id="btnHourly" aria-selected="false">時給</button>
              <button id="btnMonthly" class="active" aria-selected="true">月給</button>
              <button id="btnYearly" aria-selected="false">年収</button>
            </div>
          </div>
          <div class="row">
            <div class="label"><span id="salaryLabel">月給（税引前）</span></div>
            <div class="slider-row">
              <input id="salary" type="text" inputmode="numeric" placeholder="例：300,000" value="300,000" />
              <input id="salaryRange" type="range" min="100000" max="2000000" step="1000" />
            </div>
          </div>
          <div class="row">
            <div class="label">社保上乗せ</div>
            <div class="switch">
              <input id="overheadSoc" type="checkbox" />
              <label for="overheadSoc" class="help">社会保険の<b>事業主負担</b>を上乗せ（標準率を適用）</label>
            </div>
          </div>
        </div>

        <div class="section" id="monthlyBlock">
          <h2>2) 稼働時間（<span style="color:var(--accent-strong)">月給ベース</span>）</h2>
          <div class="row"><div class="label">月の稼働日数</div><input id="mDays" type="number" inputmode="numeric" min="1" max="31" step="1" value="20" /></div>
          <div class="help err" id="err_mDays"></div>
          <div class="row"><div class="label">1日の労働時間</div><input id="mHoursPerDay" type="number" inputmode="decimal" min="0.1" max="24" step="0.25" value="8" /></div>
          <div class="help err" id="err_mHoursPerDay"></div>
          <div class="row"><div class="label">月の稼働時間</div><input id="mHours" type="number" min="1" step="1" value="160" /></div>
          <div class="help">※ 上の2項目を変更すると自動で再計算（手入力も可）。</div>
        </div>

        <div class="section" id="yearlyBlock" style="display:none">
          <h2>2) 稼働時間（<span style="color:var(--accent-strong)">年収ベース</span>）</h2>
          <div class="row"><div class="label">年間の稼働日数</div><input id="yDays" type="number" inputmode="numeric" min="1" max="366" step="1" value="240" /></div>
          <div class="help err" id="err_yDays"></div>
          <div class="row"><div class="label">1日の労働時間</div><input id="yHoursPerDay" type="number" inputmode="decimal" min="0.1" max="24" step="0.25" value="8" /></div>
          <div class="help err" id="err_yHoursPerDay"></div>
          <div class="row"><div class="label">年間の稼働時間</div><input id="yHours" type="number" min="1" step="1" value="1920" /></div>
          <div class="help">※ 上の2項目を変更すると自動で再計算（手入力も可）。</div>
        </div>

        <div class="section">
          <h2>3) 所要時間</h2>
          <div class="row">
            <div class="label">所要時間（h）</div>
            <div class="slider-row">
              <input id="useHours" type="number" inputmode="decimal" min="0" step="0.25" value="1.0" />
              <input id="useHoursRange" type="range" min="0" max="12" step="0.25" />
            </div>
          </div>
        </div>
      </div>

      <!-- 右：結果 -->
      <div class="card">
        <div class="section">
          <h2>結果</h2>
          <div class="result">
            <div class="tile">
              <h3>時間単価（税込/ベース×上乗せ率）</h3>
              <div class="main-figure" id="hourly">–</div>
              <div class="help">社保上乗せ率（標準）：<b id="socRateLabel">–</b></div>
              <div class="help">1分あたり：<b id="perMin">–</b></div>
            </div>

            <div class="tile">
              <h3>所要時間のコスト</h3>
              <div class="main-figure" id="cost">–</div>
              <div class="help">15分：<b id="c15">–</b> ／ 30分：<b id="c30">–</b> ／ 1時間：<b id="c60">–</b></div>
            </div>

            <div class="tile">
              <h3>前提（現在の設定）</h3>
              <div class="grid-2">
                <div>
                  <div class="help">給与ベース</div>
                  <div id="baseKind" style="font-weight:700">月給</div>
                </div>
                <div>
                  <div class="help">社保上乗せ</div>
                  <div id="vhOverheadSoc" style="font-weight:700">なし</div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="grid-2">
                <div>
                  <div class="help">対象給与</div>
                  <div id="vhSalary" style="font-weight:700">–</div>
                </div>
                <div>
                  <div class="help">稼働時間（基準）</div>
                  <div id="vhWorkH" style="font-weight:700">–</div>
                </div>
              </div>
            </div>

            <div>
              <button id="copyBtn" class="btn" title="結果をクリップボードにコピー">コピー</button>
              <button id="resetBtn" class="btn secondary">リセット</button>
            </div>
          </div>
        </div>
        <div class="footer">
          <div class="note">※ このツールは、<b>単純な換算法</b>（時間単価＝給与÷稼働時間）に基づきます。労基法上の一般的な所定労働時間（1日8時間・週40時間）に合わせ、初期値を 8h×20日/月・8h×240日/年としてあります。また、社保上乗せは標準率を使用しており、実際の料率は保険者・業種・地域・年度等により異なります。</div>
        </div>
      </div>
    </div>

    <div class="credit"><span id="creditText">Copyright (c) 2025 税理士法人松本会計事務所 All Rights Reserved. / r14</span></div>
  </div>

<script>
// 初期化（DOMContentLoaded/即時の両対応）
(function(){
  let booted=false;
  function init(){
    if(booted) return; booted=true;
    try{
      const VERSION = 'r14';
      const SOC_RATE = 16.0; // 事業主負担の標準率（概算）
      const el = (id)=>document.getElementById(id);
      const on = (id,ev,fn)=>{ const e=el(id); if(e) e.addEventListener(ev,fn); };
      const fmtJPY = (n)=> new Intl.NumberFormat('ja-JP',{style:'currency', currency:'JPY', maximumFractionDigits:0}).format(n);

      const state = { mode:'monthly', salary:300000, overheadSoc:false, mDays:20, mHoursPerDay:8, mHours:160, yDays:240, yHoursPerDay:8, yHours:1920, useHours:1 };

      // 自己診断 & エラーハンドラ（任意で利用可）
      window.__diag = ()=>({ VERSION, state, found:{
        btnHourly:!!el('btnHourly'), btnMonthly:!!el('btnMonthly'), btnYearly:!!el('btnYearly'),
        salary:!!el('salary'), salaryRange:!!el('salaryRange'),
        monthlyBlock:!!el('monthlyBlock'), yearlyBlock:!!el('yearlyBlock'),
        useHours:!!el('useHours'), useHoursRange:!!el('useHoursRange')
      }});
      window.addEventListener('error', (e)=>{
        try{ const t=document.createElement('div'); t.className='toast'; t.style.background='#b91c1c'; t.textContent='Script error: '+(e.message||''); document.body.appendChild(t); setTimeout(()=>t.remove(), 4000);}catch(_){}
      }, {capture:true});

      // エラーメッセージ制御
      const errTimers={};
      function showErr(id,msg){ const e=el(id); if(!e) return; e.textContent=msg; e.style.display='block'; clearTimeout(errTimers[id]); errTimers[id]=setTimeout(()=>{ e.style.display='none'; }, 2600); }
      function hideErr(id){ const e=el(id); if(!e) return; e.style.display='none'; clearTimeout(errTimers[id]); }

      function showToast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1600); }
      function clamp(v,min,max){ v=Number(v); if(!isFinite(v)) return v; if(v<min) return min; if(v>max) return max; return v; }
      function parseMoney(text){ const cleaned = String(text||'').replace(/[^0-9.]/g,''); return Number(cleaned||0); }
      function formatMoneyToInput(num){ const s=el('salary'); if(s) s.value = (Number(num)||0).toLocaleString('ja-JP'); }
      const monthlyHours=()=> Number(state.mHours)||0; const yearlyHours=()=> Number(state.yHours)||0; const baseSalary=()=> Number(state.salary)||0;
      const loadedSalary=()=> baseSalary() * (1 + (state.overheadSoc? SOC_RATE/100 : 0));
      function hourlyRate(){ // 時間単価（円/h）
        const denom = state.mode==='monthly' ? monthlyHours() : state.mode==='yearly' ? yearlyHours() : 1; // 時給は1で割る
        const rate= denom>0? loadedSalary()/denom:0; return Math.round(rate);
      }
      const costFor=(h)=> Math.round(hourlyRate()*(Number(h)||0));

      // ---- 再計算（soft/hard） ----
      function recalcMonthly(soft=true){
        let d = Number(state.mDays); let hpd = Number(state.mHoursPerDay);
        if(!isFinite(d) || !isFinite(hpd)) return; // 未入力中は計算しない
        if(!soft){
          const d0=d, h0=hpd; d = clamp(d,1,31); hpd = clamp(hpd,0.1,24);
          if(d!==d0){ state.mDays=d; const md=el('mDays'); if(md) md.value=String(d); }
          if(hpd!==h0){ state.mHoursPerDay=hpd; const mhpd=el('mHoursPerDay'); if(mhpd) mhpd.value=String(hpd); }
        }
        state.mHours = d*hpd; const mh=el('mHours'); if(mh) mh.value = String(state.mHours);
      }
      function recalcYearly(soft=true){
        let d = Number(state.yDays); let hpd = Number(state.yHoursPerDay);
        if(!isFinite(d) || !isFinite(hpd)) return;
        if(!soft){
          const d0=d, h0=hpd; d = clamp(d,1,366); hpd = clamp(hpd,0.1,24);
          if(d!==d0){ state.yDays=d; const yd=el('yDays'); if(yd) yd.value=String(d); }
          if(hpd!==h0){ state.yHoursPerDay=hpd; const yhpd=el('yHoursPerDay'); if(yhpd) yhpd.value=String(hpd); }
        }
        state.yHours = d*hpd; const yh=el('yHours'); if(yh) yh.value = String(state.yHours);
      }

      function syncSalaryRange(){
        const r=el('salaryRange'); if(!r) return;
        if(state.mode==='monthly'){ r.min=100000; r.max=2000000; r.step=1000; }
        else if(state.mode==='yearly'){ r.min=1000000; r.max=30000000; r.step=10000; }
        else { /* 時給 */ r.min=800; r.max=10000; r.step=10; }
        r.value=String(baseSalary());
      }
      function syncUseHoursRange(){ const r=el('useHoursRange'); if(!r) return; r.min=0; r.max=12; r.step=0.25; r.value=String(state.useHours||0); }

      function updateVisibility(){
        const mb=el('monthlyBlock'), yb=el('yearlyBlock');
        if(mb) mb.style.display = state.mode==='monthly'? '' : 'none';
        if(yb) yb.style.display = state.mode==='yearly' ? '' : 'none';
      }

      function updateView(){
        const sl=el('salaryLabel'); if(sl) sl.textContent = state.mode==='monthly'? '月給（税引前）' : state.mode==='yearly'? '年収（税引前）' : '時給（税引前）';
        const bk=el('baseKind'); if(bk) bk.textContent = state.mode==='monthly'? '月給' : state.mode==='yearly'? '年収' : '時給';
        const vhO=el('vhOverheadSoc'); if(vhO) vhO.textContent = state.overheadSoc ? `あり（${SOC_RATE}%）` : 'なし';
        const sr=el('socRateLabel'); if(sr) sr.textContent = `${SOC_RATE}%`;
        formatMoneyToInput(baseSalary());
        syncSalaryRange();
        syncUseHoursRange();
        updateVisibility();
        const vhs=el('vhSalary'); if(vhs) vhs.textContent = fmtJPY(baseSalary());
        const wh = state.mode==='monthly'? monthlyHours() : state.mode==='yearly'? yearlyHours() : null;
        const vhw=el('vhWorkH'); if(vhw) vhw.textContent = (wh==null)? '—' : (wh.toLocaleString('ja-JP') + ' 時間/' + (state.mode==='monthly'? '月':'年'));
        const h = hourlyRate();
        const hh=el('hourly'); if(hh) hh.textContent = fmtJPY(h) + ' / 時間';
        const pm=el('perMin'); if(pm) pm.textContent = fmtJPY(Math.round(h/60));
        const useH = Number(state.useHours)||0;
        const cst=el('cost'); if(cst) cst.textContent = fmtJPY(costFor(useH));
        const c15=el('c15'); if(c15) c15.textContent = fmtJPY(costFor(0.25));
        const c30=el('c30'); if(c30) c30.textContent = fmtJPY(costFor(0.5));
        const c60=el('c60'); if(c60) c60.textContent = fmtJPY(costFor(1));
        const bm=el('btnMonthly'), by=el('btnYearly'), bh=el('btnHourly');
        if(bm) bm.classList.toggle('active', state.mode==='monthly');
        if(by) by.classList.toggle('active', state.mode==='yearly');
        if(bh) bh.classList.toggle('active', state.mode==='hourly');
      }

      function copySummary(){
        const base = state.mode==='monthly'? '月給' : state.mode==='yearly'? '年収' : '時給';
        const workLine = state.mode==='monthly' ? `稼働時間：${state.mHours.toLocaleString('ja-JP')} 時間/月` : state.mode==='yearly' ? `稼働時間：${state.yHours.toLocaleString('ja-JP')} 時間/年` : `稼働時間：—（時給ベース）`;
        const txt=[
          '【時間単価・コスト可視化】',
          `給与ベース：${base}`,
          `対象給与：${fmtJPY(baseSalary())}`,
          `社保上乗せ：${state.overheadSoc?`あり（${SOC_RATE}%）`:'なし'}`,
          workLine,
          `時間単価：${fmtJPY(hourlyRate())} /h`,
          `1分あたり：${fmtJPY(Math.round(hourlyRate()/60))}`,
          `15分：${fmtJPY(costFor(0.25))} ／ 30分：${fmtJPY(costFor(0.5))} ／ 1時間：${fmtJPY(costFor(1))}`,
          `(ver ${VERSION})`
        ].join('
');
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(()=>{ showToast('コピーしました'); }).catch(()=>{
            const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('コピーしました');
          });
        }else{
          const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('コピーしました');
        }
      }

      function resetAll(){
        Object.assign(state,{mode:'monthly', salary:300000, overheadSoc:false, mDays:20, mHoursPerDay:8, mHours:160, yDays:240, yHoursPerDay:8, yHours:1920, useHours:1});
        formatMoneyToInput(state.salary); const ov=el('overheadSoc'); if(ov) ov.checked=false; const md=el('mDays'); if(md) md.value='20'; const mhpd=el('mHoursPerDay'); if(mhpd) mhpd.value='8'; const mh=el('mHours'); if(mh) mh.value='160'; const yd=el('yDays'); if(yd) yd.value='240'; const yhpd=el('yHoursPerDay'); if(yhpd) yhpd.value='8'; const yh=el('yHours'); if(yh) yh.value='1920'; const uh=el('useHours'); if(uh) uh.value='1.0'; syncUseHoursRange(); updateView(); save(); showToast('リセットしました');
        hideErr('err_mDays'); hideErr('err_mHoursPerDay'); hideErr('err_yDays'); hideErr('err_yHoursPerDay');
      }

      // ---- events（入力中はclampしない／確定時にclamp） ----
      on('btnMonthly','click', ()=>{ state.mode='monthly'; updateView(); save(); });
      on('btnYearly','click',  ()=>{ state.mode='yearly';  updateView(); save(); });
      on('btnHourly','click',  ()=>{ state.mode='hourly';  updateView(); save(); });

      on('salary','input', (e)=>{ state.salary=parseMoney(e.target.value); const r=el('salaryRange'); if(r) r.value=String(baseSalary()); updateView(); save(); });
      on('salary','blur',  ()=>{ formatMoneyToInput(baseSalary()); });
      on('salaryRange','input', (e)=>{ state.salary=Number(e.target.value)||0; formatMoneyToInput(baseSalary()); updateView(); save(); });
      on('overheadSoc','change', (e)=>{ state.overheadSoc=!!e.target.checked; updateView(); save(); });

      // 月
      on('mDays','input',(e)=>{ const v=e.target.value; const n=Number(v); if(isFinite(n)) { state.mDays=n; recalcMonthly(true); updateView(); save(); } });
      on('mDays','blur', (e)=>{ let n=Number(e.target.value); if(!isFinite(n)) n=20; const raw=n; n=clamp(n,1,31); if(raw>31){ showErr('err_mDays','月の稼働日数の上限は31日です（入力値を補正しました）'); } else { hideErr('err_mDays'); } state.mDays=n; e.target.value=String(n); recalcMonthly(false); updateView(); save(); });
      on('mHoursPerDay','input',(e)=>{ const v=e.target.value; const n=parseFloat(v); if(!isNaN(n)) { state.mHoursPerDay=n; recalcMonthly(true); updateView(); save(); } });
      on('mHoursPerDay','blur', (e)=>{ let n=parseFloat(e.target.value); if(isNaN(n)) n=8; const raw=n; n=clamp(n,0.1,24); if(raw>24){ showErr('err_mHoursPerDay','1日の労働時間の上限は24時間です（入力値を補正しました）'); } else { hideErr('err_mHoursPerDay'); } state.mHoursPerDay=n; e.target.value=String(n); recalcMonthly(false); updateView(); save(); });
      on('mHours','input',(e)=>{ const n=Number(e.target.value); if(isFinite(n)) { state.mHours=n; updateView(); save(); } });

      // 年
      on('yDays','input',(e)=>{ const v=e.target.value; const n=Number(v); if(isFinite(n)) { state.yDays=n; recalcYearly(true); updateView(); save(); } });
      on('yDays','blur', (e)=>{ let n=Number(e.target.value); if(!isFinite(n)) n=240; const raw=n; n=clamp(n,1,366); if(raw>366){ showErr('err_yDays','年間の稼働日数の上限は366日です（入力値を補正しました）'); } else { hideErr('err_yDays'); } state.yDays=n; e.target.value=String(n); recalcYearly(false); updateView(); save(); });
      on('yHoursPerDay','input',(e)=>{ const v=e.target.value; const n=parseFloat(v); if(!isNaN(n)) { state.yHoursPerDay=n; recalcYearly(true); updateView(); save(); } });
      on('yHoursPerDay','blur', (e)=>{ let n=parseFloat(e.target.value); if(isNaN(n)) n=8; const raw=n; n=clamp(n,0.1,24); if(raw>24){ showErr('err_yHoursPerDay','1日の労働時間の上限は24時間です（入力値を補正しました）'); } else { hideErr('err_yHoursPerDay'); } state.yHoursPerDay=n; e.target.value=String(n); recalcYearly(false); updateView(); save(); });
      on('yHours','input',(e)=>{ const n=Number(e.target.value); if(isFinite(n)) { state.yHours=n; updateView(); save(); } });

      // 所要時間
      on('useHours','input', (e)=>{ const n=parseFloat(e.target.value); if(!isNaN(n)) { state.useHours=n; const r=el('useHoursRange'); if(r) r.value=String(state.useHours); updateView(); save(); } });
      on('useHoursRange','input', (e)=>{ state.useHours=Number(e.target.value)||0; const u=el('useHours'); if(u) u.value=String(state.useHours); updateView(); save(); });

      on('copyBtn','click', copySummary);
      on('resetBtn','click', resetAll);

      // persist
      const KEY='rate_tool_r14';
      function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
      function load(){ try{ const s = JSON.parse(localStorage.getItem(KEY)||localStorage.getItem('rate_tool_r13')||'null'); if(s){ Object.assign(state,s); } }catch(e){} }

      // init
      load();
      formatMoneyToInput(state.salary);
      const ov=el('overheadSoc'); if(ov) ov.checked=!!state.overheadSoc;
      const md=el('mDays'); if(md) md.value=state.mDays; const mhpd=el('mHoursPerDay'); if(mhpd) mhpd.value=state.mHoursPerDay; const mh=el('mHours'); if(mh) mh.value=state.mHours;
      const yd=el('yDays'); if(yd) yd.value=state.yDays; const yhpd=el('yHoursPerDay'); if(yhpd) yhpd.value=state.yHoursPerDay; const yh=el('yHours'); if(yh) yh.value=state.yHours;
      const uh=el('useHours'); if(uh) uh.value=state.useHours; syncUseHoursRange();
      syncSalaryRange();
      updateVisibility();
      updateView();

      const year = new Date().getFullYear();
      const cr=el('creditText'); if(cr) cr.textContent = `Copyright (c) ${year} 税理士法人松本会計事務所 All Rights Reserved. / ${VERSION}`;

      // デバッグバッジ（URL末尾に#debug で表示）
      const hash = (location.hash||'').toLowerCase();
      if(hash.includes('debug')){
        const badge=document.createElement('div');
        badge.style.cssText='position:fixed;top:6px;right:6px;background:#10b981;color:#fff;padding:4px 6px;border-radius:6px;font-size:12px;z-index:9999;';
        badge.textContent='init ok: '+VERSION;
        document.body.appendChild(badge);
      }
    }catch(err){
      console.error(err);
      const div = document.createElement('div');
      div.className='toast';
      div.style.background='#fff3cd'; div.style.color='#856404'; div.style.border='1px solid #ffeeba';
      div.textContent='初期化エラー。ブラウザのConsoleを確認してください。';
      document.body.appendChild(div); setTimeout(()=>div.remove(), 4000);
    }
  }
  if(document.readyState==='interactive' || document.readyState==='complete'){ init(); }
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
