<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>それ、売上に直すといくらですか？</title>
  <meta name="theme-color" content="#2f7f86" />
  <style>
    :root{
      --bg:#f4f9fb; --card:#ffffff; --ink:#1e2a2d; --muted:#5a6a6d;
      --accent:#2f7f86; --accent-2:#4ea4ad; --shadow:0 10px 30px rgba(35,80,90,.12);
      --radius:16px;
    }
    html,body{height:100%;}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN",
      "Yu Gothic UI","YuGothic","Noto Sans JP","Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased;}
    .wrap{padding:max(12px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
           calc(16px + env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
           max-width:560px; margin:0 auto;}
    header{padding:14px 10px 2px;}
    .title{font-weight:800; letter-spacing:.02em; line-height:1.25; font-size:clamp(20px,5.5vw,26px); margin:0 0 6px;}
    .subtitle{color:var(--muted); font-size:12px;}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px 16px; margin:12px 0 18px;}
    .field{margin:10px 0 16px;}
    .label{font-size:15px; color:var(--muted); margin:0 0 6px 2px;}
    .label.big{font-size:16px; font-weight:700; color:#324245;}
    .helper{font-size:12px; color:#6a7a7d; margin:4px 2px 0;}
    .ref-title{margin:10px 2px 0; font-size:12px; color:#607c80;}
    .range-row{display:flex; align-items:center; gap:12px; padding:8px 0;}
    input[type="range"]{-webkit-appearance:none; width:100%; height:26px; background:transparent;}
    input[type="range"]::-webkit-slider-runnable-track{height:6px; background:linear-gradient(90deg,var(--accent-2),var(--accent)); border-radius:999px;}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; width:26px; height:26px; border-radius:50%;
      background:#fff; border:2px solid var(--accent); margin-top:-10px; box-shadow:0 1px 6px rgba(0,0,0,.08);}
    .yen-input,.pctbox{display:flex; align-items:center; gap:8px; background:#f8fcfd; border:1px solid #d9eaed; border-radius:12px; padding:8px 10px;}
    .yen-input .prefix{font-weight:700; color:var(--accent); border-right:1px solid #e6f1f3; padding-right:10px;}
    input.money,input.pct{border:0; outline:none; background:transparent; font-size:20px; font-weight:800; color:var(--ink);
      letter-spacing:.02em; width:120px; text-align:right; font-feature-settings:"tnum"; font-variant-numeric:tabular-nums;}
    .pctbox .unit{font-weight:800; color:var(--ink);}
    .chip-grid{display:grid; gap:8px; margin-top:8px; grid-template-columns:repeat(4, minmax(0,1fr));}
    @media (max-width:380px){.chip-grid{grid-template-columns:repeat(3, minmax(0,1fr));}}
    .chip{display:flex; align-items:center; justify-content:space-between; border:1px solid #d9eaed; background:#f3fafb; color:var(--accent);
      padding:8px 10px; border-radius:12px; font-size:12px; line-height:1.05; cursor:pointer;}
    .chip .nm{font-weight:700;} .chip .val{font-weight:900; color:#1f3a3e; font-feature-settings:"tnum";}
    .btn{background:linear-gradient(180deg,var(--accent-2),var(--accent)); color:#fff; font-weight:900; letter-spacing:.02em;
      border:0; width:100%; border-radius:12px; padding:16px 18px; font-size:17px; box-shadow:var(--shadow);}
    .btn:active{transform:translateY(1px);} .btn.secondary{background:#eef7f8; color:var(--accent); box-shadow:none; border:1px solid #d9eaed;}
    .result{text-align:center; margin-top:16px;}
    .result .label{font-size:16px; font-weight:800; color:#324245;}
    .amount{font-size:clamp(24px,7.5vw,36px); font-weight:900; color:var(--accent); margin:8px 0 6px; font-feature-settings:"tnum"; font-variant-numeric:tabular-nums;}
    .statement{margin-top:12px; font-size:clamp(17px,5.2vw,21px); font-weight:900; line-height:1.5; color:#0f2022;
      background:#e9f6f8; border:1px dashed var(--accent-2); padding:12px; border-radius:12px;}
    .note{margin-top:10px; color:var(--muted); font-size:12px;}
    footer{margin:18px 4px 6px; text-align:center; color:#667; font-size:11px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">それ、売上に直すといくらですか？</h1>
      <div class="subtitle">支出や投資の金額を「御社の売上相当額」に換算して意思決定の質を高めましょう。</div>
    </header>

    <section class="card" aria-label="入力">
      <!-- ① 支出額：スライダー左 / 入力欄 右（初期値 100,000円） -->
      <div class="field">
        <div class="label big">① 支出額（円）</div>
        <div class="range-row" title="支出額スライダー">
          <input id="spendRange" type="range" min="0" max="1000000" step="1000" value="100000" />
          <div class="yen-input compact">
            <span class="prefix">¥</span>
            <input id="spend" class="money" type="text" inputmode="numeric" value="100,000" autocomplete="off" />
          </div>
        </div>
      </div>

      <!-- ② 限界利益率：スライダー + 直接入力（0.1%刻み・初期値54.7%） -->
      <div class="field">
        <div class="label big">② 御社の限界利益率（％）</div>
        <div class="helper">※変動損益計算書もしくは月次決算速報サービスにてご確認ください</div>
        <div class="range-row">
          <!-- 5.0% 〜 95.0% -->
          <input id="cmr" type="range" min="5" max="95" step="0.1" value="54.7" aria-label="限界利益率スライダー" />
          <div class="pctbox">
            <input id="cmrInput" class="pct" type="text" inputmode="decimal" value="54.7" aria-label="限界利益率(直接入力)" />
            <span class="unit">%</span>
          </div>
        </div>

        <!-- 参考見出し -->
        <div class="ref-title">参考：産業ごとの全国平均</div>
        <!-- 業種チップ -->
        <div class="chip-grid" aria-label="業種プリセット">
          <button class="chip" data-pct="54.7"><span class="nm">全産業</span><span class="val">54.7%</span></button>
          <button class="chip" data-pct="65.7"><span class="nm">漁業</span><span class="val">65.7%</span></button>
          <button class="chip" data-pct="48.0"><span class="nm">建設業</span><span class="val">48.0%</span></button>
          <button class="chip" data-pct="58.0"><span class="nm">製造業</span><span class="val">58.0%</span></button>
          <button class="chip" data-pct="29.7"><span class="nm">卸売業</span><span class="val">29.7%</span></button>
          <button class="chip" data-pct="35.7"><span class="nm">小売業</span><span class="val">35.7%</span></button>
          <button class="chip" data-pct="82.4"><span class="nm">宿泊業</span><span class="val">82.4%</span></button>
          <button class="chip" data-pct="64.2"><span class="nm">飲食業</span><span class="val">64.2%</span></button>
        </div>
      </div>

      <div class="field">
        <button id="calc" class="btn" type="button">売上相当額を計算</button>
      </div>
      <div class="field">
        <button id="reset" class="btn secondary" type="button">リセット</button>
      </div>

      <div class="result" id="resultArea" hidden>
        <div class="label big">御社の売上相当額</div>
        <div class="amount" id="sales"></div>
        <div class="statement" id="statement"></div>
        <div class="note">
          ※ 計算式：<b>御社の売上相当額 ＝ 支出額 ÷（限界利益率 / 100）</b><br>
          ※各産業平均は令和7年版TKC経営指標（BAST）を参照しています。
        </div>
      </div>
    </section>

    <footer>
      Copyright (c) <span id="yyyy"></span> 税理士法人松本会計事務所 All Rights Reserved. / r7
    </footer>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);

    const spendEl = $('#spend');
    const spendRange = $('#spendRange');

    const cmrRange = $('#cmr');
    const cmrInput = $('#cmrInput');

    const resultArea = $('#resultArea');
    const salesEl = $('#sales');
    const statementEl = $('#statement');

    $('#yyyy').textContent = String(new Date().getFullYear());

    function parseMoney(text){ if(!text) return NaN; return Number(String(text).replace(/[^\d.-]/g,'')); }
    function formatJPY(n){ return n.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}); }
    function formatPlainJPY(n){ return n.toLocaleString('ja-JP',{maximumFractionDigits:0}); }
    function parsePct(text){
      if(text==null) return NaN;
      const t = String(text).replace('%','').replace(',', '.').trim();
      return Number(t);
    }
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    // 支出額：スライダー → 入力欄
    spendRange.addEventListener('input', ()=>{
      const val = Number(spendRange.value);
      spendEl.value = formatPlainJPY(val);
    });
    // 支出額：入力欄 → スライダー
    spendEl.addEventListener('input', (e)=>{
      const raw = parseMoney(e.target.value);
      if(isNaN(raw)) return;
      e.target.value = formatPlainJPY(raw);
      spendRange.value = clamp(raw, Number(spendRange.min), Number(spendRange.max));
    });
    spendRange.dispatchEvent(new Event('input')); // 初期同期

    // ===== 限界利益率 入力体験の改善 =====
    // スライダー → 入力（入力欄にフォーカスがある間は上書きしない）
    function syncCmrFromSlider(){
      if(document.activeElement === cmrInput) return;        // ← これで削除操作を邪魔しない
      cmrInput.value = Number(cmrRange.value).toFixed(1);
    }
    cmrRange.addEventListener('input', syncCmrFromSlider);
    syncCmrFromSlider();

    // 入力中は値を上書きしない。確定タイミング（blur/Enter/計算実行）で丸めて反映。
    function commitCmrInput(){
      const min = Number(cmrRange.min), max = Number(cmrRange.max);
      const v = parsePct(cmrInput.value);
      if(isNaN(v)){ cmrInput.value = Number(cmrRange.value).toFixed(1); return; }
      const clamped = clamp(v, min, max);
      cmrRange.value = clamped.toFixed(1);
      cmrInput.value = clamped.toFixed(1);
    }

    cmrInput.addEventListener('input', ()=>{
      // 入力中はスライダーの位置だけ可能なら更新（範囲外や空欄は無視）
      const v = parsePct(cmrInput.value);
      const min = Number(cmrRange.min), max = Number(cmrRange.max);
      if(!isNaN(v) && v>=min && v<=max){
        cmrRange.value = Number(v).toFixed(1);
      }
    });
    cmrInput.addEventListener('blur', commitCmrInput);

    // 計算
    function calc(){
      commitCmrInput(); // ← 計算前に入力値を確定
      const spend = parseMoney(spendEl.value);
      const pct = parsePct(cmrInput.value);
      if(isNaN(spend) || spend <= 0){ alert('支出額を正しく入力してください。'); spendEl.focus(); return; }
      if(isNaN(pct) || pct <= 0){ alert('限界利益率を正しく入力してください。'); cmrInput.focus(); return; }
      const rate = pct / 100;
      const salesNeeded = Math.ceil(spend / rate);
      salesEl.textContent = formatJPY(salesNeeded);
      statementEl.textContent = `${formatJPY(spend)} の支出は、御社の売上 ${formatJPY(salesNeeded)} に相当します。`;
      resultArea.hidden = false;
      resultArea.scrollIntoView({behavior:'smooth', block:'center'});
    }

    $('#calc').addEventListener('click', calc);
    cmrInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); calc(); }});
    spendEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); calc(); }});

    // リセット（初期値へ）
    $('#reset').addEventListener('click', ()=>{
      spendRange.value = 100000; spendRange.dispatchEvent(new Event('input'));
      cmrRange.value = 54.7; syncCmrFromSlider();
      resultArea.hidden = true; window.scrollTo({top:0, behavior:'smooth'});
    });
  </script>
</body>
</html>